{% extends "base.html" %}

{% block title %}Classroom Attendance System{% endblock %}

{% block extra_css %}
    {% include 'partials/styles.html' %}
{% endblock %}

{% block content %}
    <!-- Add loading screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Classroom Attendance System</div>
        <div class="loading-subtext" id="loadingSubtext">Initializing...</div>
    </div>

    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-user-check"></i> Classroom Attendance System</h1>
                <p class="mb-0">Real-time face recognition for automatic attendance tracking</p>
                <div class="mt-3" style="margin-bottom: 10px;">
                    <span class="status-indicator" id="systemStatus"></span>
                    <span id="statusText">System Status</span>
                </div>
                <!-- Replace the existing class-select-container with this: -->
                <div class="class-select-container">
                    <label for="classSelect" class="class-label">
                        <i class="fas fa-chalkboard-teacher"></i>
                        Class:
                    </label>
                    <select id="classSelect" class="class-selector" onchange="changeClass()">
                        <option value="">Loading classes...</option>
                    </select>
                    <button class="btn btn-outline-light btn-sm ms-2" onclick="showCreateClassModal()">
                        <i class="fas fa-plus"></i> Create New Class
                    </button>
                </div>
                
                <!-- Compact stats display -->
                <div class="row mt-2">
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="stats-number" id="presentCount">0</div>
                            <div style="font-size: 0.8rem;">Present Students</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="stats-number" id="totalStudents">0</div>
                            <div style="font-size: 0.8rem;">Total Students</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add this after the class selector in the header -->
            <div class="mt-2">
                <button class="btn btn-outline-light btn-sm me-2" onclick="showCacheStats()">
                    <i class="fas fa-chart-bar"></i> Cache Stats
                </button>
                <button class="btn btn-outline-light btn-sm me-2" onclick="cleanupCache()">
                    <i class="fas fa-broom"></i> Cleanup Cache
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="clearCache()">
                    <i class="fas fa-trash"></i> Clear Cache
                </button>
            </div>

            <!-- Add this after the class selector or in the control panel -->
            <div class="camera-controls">
                <div class="camera-toggle-container">
                    <label class="camera-label">
                        <i class="fas fa-camera"></i>
                        Camera Source:
                    </label>
                    <div class="camera-toggle-buttons">
                        <button id="localCameraBtn" class="btn btn-outline-primary btn-sm camera-btn active">
                            <i class="fas fa-desktop"></i> Local
                        </button>
                        <button id="ipCameraBtn" class="btn btn-outline-primary btn-sm camera-btn">
                            <i class="fas fa-mobile-alt"></i> Phone
                        </button>
                    </div>
                    <div class="camera-status">
                        <span id="cameraStatus" class="status-indicator status-inactive"></span>
                        <span id="cameraStatusText">Disconnected</span>
                    </div>
                </div>
                
                <div id="ipCameraSettings" class="ip-camera-settings" style="display: none;">
                    <div class="input-group">
                        <input type="text" id="ipCameraUrl" class="form-control" 
                               placeholder="http://192.168.1.100:8080/video" 
                               value="http://192.168.1.100:8080/video">
                        <button class="btn btn-primary" onclick="setIpCameraUrl()">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button class="btn btn-outline-secondary" onclick="testIpCamera()">
                            <i class="fas fa-wifi"></i> Test
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <strong>Common IP Camera Apps:</strong><br>
                            • <strong>IP Webcam (Android):</strong> http://[PHONE_IP]:8080/video<br>
                            • <strong>DroidCam:</strong> http://[PHONE_IP]:4747/video<br>
                            • <strong>EpocCam:</strong> http://[PHONE_IP]:8080/video<br>
                            • <strong>ManyCam:</strong> http://[PHONE_IP]:8080/video<br>
                            <em>Replace [PHONE_IP] with your phone's IP address (e.g., 192.168.1.100)</em>
                        </small>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="tab-content">
                <!-- Navigation Tabs -->
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="live-tab" data-bs-toggle="tab" data-bs-target="#live" type="button" role="tab">
                            <i class="fas fa-video"></i> Live Detection
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button" role="tab">
                            <i class="fas fa-history"></i> Sessions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">
                            <i class="fas fa-users"></i> Students
                        </button>
                    </li>
                </ul>

                <!-- Tab Contents -->
                <div class="tab-content" id="mainTabContent">
                    <!-- Detection Tab -->
                    <div class="tab-pane fade show active" id="live" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <!-- Session controls -->
                                <div class="control-panel">
                                    <div class="row g-2 align-items-center">
                                        <div class="col-auto">
                                            <label for="sessionName" class="col-form-label" style="font-size: 0.9rem;">Session Name</label>
                                        </div>
                                        <div class="col-auto">
                                            <input type="text" id="sessionName" class="form-control form-control-sm" placeholder="e.g. Math 101" required>
                                        </div>
                                        <div class="col-auto">
                                            <label for="sessionStartTime" class="col-form-label" style="font-size: 0.9rem;">Class Start Time</label>
                                        </div>
                                        <div class="col-auto">
                                            <input type="datetime-local" id="sessionStartTime" class="form-control form-control-sm">
                                        </div>
                                        <div class="col-auto">
                                            <button id="startBtn" class="btn btn-start btn-custom btn-sm" onclick="startDetection()">
                                                <i class="fas fa-play"></i> Start Detection
                                            </button>
                                            <button id="stopBtn" class="btn btn-stop btn-custom btn-sm" onclick="stopDetection()" disabled>
                                                <i class="fas fa-stop"></i> Stop Detection
                                            </button>
                                            <button class="btn btn-secondary ms-2" id="resumeSessionBtn" style="display:none;">
                                                <i class="fas fa-history"></i> Resume Session
                                            </button>
                                            <!-- Add Enter Idle Mode button here -->
                                            <button class="btn btn-info btn-custom btn-sm ms-2" id="enterIdleBtn" style="display:none;" onclick="enterIdleMode()">
                                                <i class="fas fa-pause"></i> Enter Idle Mode
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Video feed -->
                                <div class="video-container mt-3" style="position:relative;">
                                    <!-- Attendance Toast (above webcam feed) -->
                                    <div id="attendanceToast" class="attendance-toast" style="display:none; position:absolute; left:50%; top:30px; transform:translateX(-50%); z-index:20;">
                                        <i class="fas fa-check-circle"></i>
                                        <span id="attendanceToastText"></span>
                                    </div>
                                    
                                    <!-- Standby indicator (small badge) -->
                                    <div id="standbyIndicator" class="standby-indicator">
                                        <i class="fas fa-clock"></i> Standby Mode
                                    </div>
                                    
                                    <!-- Standby overlay (full screen) -->
                                    <div id="standbyOverlay" class="standby-overlay">
                                        <h3><i class="fas fa-clock"></i> Standby Mode</h3>
                                        <p>Please stand still for detection</p>
                                        <p>Detection will resume automatically when you are detected</p>
                                        <div class="cycle-info">
                                            <i class="fas fa-info-circle"></i> Detection cycle: 2.0s
                                        </div>
                                    </div>
                                    
                                    <!-- Idle overlay -->
                                    <div id="idleOverlay" class="idle-overlay">
                                        <h3><i class="fas fa-pause-circle"></i> System Idle</h3>
                                        <p>No faces detected for 5 minutes</p>
                                        <button class="btn-resume" onclick="resumeDetection()">
                                            <i class="fas fa-play"></i> Resume Detection
                                        </button>
                                    </div>
                                    
                                    <img src="/video_feed" class="video-feed" alt="Video Feed" id="videoFeed">
                                </div>
                                <!-- Add this button below the video feed -->
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn btn-primary btn-sm" onclick="captureCurrentFrame()">
                                        <i class="fas fa-camera"></i> Capture Unknown Faces
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="attendance-card">
                                    <h6><i class="fas fa-user-check"></i> Live Attendance</h6>
                                    <div id="liveAttendanceList">
                                        <p class="text-muted">No students detected yet.</p>
                                    </div>
                                </div>
                                <div class="attendance-card mt-3">
                                    <h6><i class="fas fa-user-times"></i> Not Yet Present</h6>
                                    <div id="absentStudentsList">
                                        <p class="text-muted">No data.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sessions Tab -->
                    <div class="tab-pane fade" id="sessions" role="tabpanel">
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4><i class="fas fa-history"></i> Previous Sessions</h4>
                                    <button class="btn btn-primary" onclick="loadSessions()">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                </div>
                                <div id="sessionsList">
                                    <div class="loading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading sessions...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Students Tab -->
                    <div class="tab-pane fade" id="students" role="tabpanel">
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4><i class="fas fa-users"></i> Registered Students</h4>
                                    <button class="btn btn-primary" onclick="loadStudents()">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                </div>
                                <div id="studentsList">
                                    <div class="loading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading students...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Details Modal -->
    <div class="modal fade" id="sessionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Session Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="sessionModalBody">
                    <!-- Session details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="exportBtn" onclick="exportSession()">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <div class="form-check form-check-inline mb-3">
                                <input class="form-check-input" type="radio" name="addMethod" id="singleImageRadio" value="single" checked>
                                <label class="form-check-label" for="singleImageRadio">Single Image</label>
                            </div>
                            <div class="form-check form-check-inline mb-3">
                                <input class="form-check-input" type="radio" name="addMethod" id="folderUploadRadio" value="folder">
                                <label class="form-check-label" for="folderUploadRadio">Multiple Images (Folder)</label>
                            </div>
                            <div class="form-check form-check-inline mb-3">
                                <input class="form-check-input" type="radio" name="addMethod" id="existingFolderRadio" value="existing">
                                <label class="form-check-label" for="existingFolderRadio">Existing Folder</label>
                            </div>
                        </div>
                        <div class="col-md-6" id="singleImageSection">
                            <h6>Add Single Image</h6>
                            <div class="mb-3">
                                <label for="studentName" class="form-label">Student Name</label>
                                <input type="text" class="form-control" id="studentName" required>
                            </div>
                            <div class="mb-3">
                                <label for="studentImage" class="form-label">Student Image (JPG, PNG, JPEG)</label>
                                <input type="file" class="form-control" id="studentImage" accept="image/*" required>
                            </div>
                            <div class="mb-3">
                                <label for="studentFolder" class="form-label">Folder for Single Image (Optional)</label>
                                <input type="text" class="form-control" id="studentFolder" placeholder="e.g., JohnDoe">
                            </div>
                        </div>
                        <div class="col-md-6" id="folderUploadSection" class="d-none">
                            <h6>Add Multiple Images (Folder)</h6>
                            <div class="mb-3">
                                <label for="folderStudentName" class="form-label">Student Name</label>
                                <input type="text" class="form-control" id="folderStudentName" required>
                            </div>
                            <div class="mb-3">
                                <label for="folderName" class="form-label">Folder Name</label>
                                <input type="text" class="form-control" id="folderName" required>
                            </div>
                            <div class="mb-3">
                                <label for="folderImages" class="form-label">Select Images (JPG, PNG, JPEG)</label>
                                <input type="file" class="form-control" id="folderImages" accept="image/*" multiple required>
                            </div>
                        </div>
                        <div class="col-md-6" id="existingFolderSection" class="d-none">
                            <h6>Add from Existing Folder</h6>
                            <div class="mb-3">
                                <label for="existingStudentName" class="form-label">Student Name</label>
                                <input type="text" class="form-control" id="existingStudentName" required>
                            </div>
                            <div class="mb-3">
                                <label for="existingFolderPath" class="form-label">Folder Path</label>
                                <input type="text" class="form-control" id="existingFolderPath" required>
                            </div>
                            <div id="folderContents" class="border rounded p-3 bg-light">
                                <small class="text-muted">Select a folder to see its contents</small>
                            </div>
                        </div>
                    </div>
                </div>
          
                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitAddStudent()">
                        <i class="fas fa-plus"></i> Add Student
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notification for attendance -->
    <div id="attendanceToast" class="attendance-toast" style="display:none;">
        <i class="fas fa-user-check"></i>
        <span id="attendanceToastText"></span>
    </div>

    <!-- Resume Session Modal -->
    <div class="modal fade" id="resumeSessionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Resume Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Select a session to resume:</p>
                    <div id="resumeSessionList">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading sessions...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Class Modal -->
    <div class="modal fade" id="createClassModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newClassName" class="form-label">Class Name</label>
                                <input type="text" class="form-control" id="newClassName" placeholder="e.g., CI2504P, CI2601D" required>
                            </div>
                            <div class="mb-3">
                                <label for="csvFile" class="form-label">Student CSV File</label>
                                <input type="file" class="form-control" id="csvFile" accept=".csv" required>
                                <div class="form-text">Upload a CSV file with student information</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> CSV Format Requirements:</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Required Columns:</strong></p>
                                        <ul class="mb-2">
                                            <li><code>Serial</code> - Student number</li>
                                            <li><code>Name</code> - Student's full name</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Example:</strong></p>
                                        <code class="small">
                                            Serial,Name<br>
                                            01,John Doe<br>
                                            02,Jane Smith
                                        </code>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> CCSTARS Data Source:</h6>
                                <p class="mb-2">Student index and name data can be obtained from CCSTARS to create your CSV file.</p>
                            </div>
                            
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-triangle"></i> Important Warnings:</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>CSV Formatting:</strong></p>
                                        <ul class="mb-2 small">
                                            <li>No commas in student names</li>
                                            <li>No special characters</li>
                                            <li>Use leading zeros (01, 02...)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle"></i> What Happens Next:</h6>
                                <ul class="mb-0 small">
                                    <li>Student folders created: <code>01_John Doe/</code>, <code>02_Jane Smith/</code></li>
                                    <li>You can then add student photos to these folders</li>
                                    <li>Students will appear in numerical order in the system</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div id="createClassProgress" style="display: none;">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Creating class...</span>
                            </div>
                            <p class="mt-2">Creating class folders...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createNewClass()">
                        <i class="fas fa-plus"></i> Create Class
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <!-- Include all JavaScript files -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/detection.js') }}"></script>
    <script src="{{ url_for('static', filename='js/attendance.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sessions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/camera.js') }}"></script>
    <script src="{{ url_for('static', filename='js/classes.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
{% endblock %} 